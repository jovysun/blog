<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">


























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=6.7.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/assets/32x32.ico?v=6.7.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/assets/32x32.ico?v=6.7.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/assets/16x16.ico?v=6.7.0">


  <link rel="mask-icon" href="/assets/32x32.ico?v=6.7.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '6.7.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="概述对于 loader，我们用了很多，熟悉的有 css-loader、file-loader 等。但是 loader 的机制是什么，基本的 loader 结构是怎样的，如何搭建一个 loader 开发调试环境，如何自己编写一个 loader，异步 loader 怎么处理，怎么在 loader 中运用第三方 npm 包。本文将对以上问题进行讲解。">
<meta name="keywords" content="webpack">
<meta property="og:type" content="article">
<meta property="og:title" content="编写一个webpack的loader">
<meta property="og:url" content="http://hellojovy.com/webpack-loader/index.html">
<meta property="og:site_name" content="程序收纳">
<meta property="og:description" content="概述对于 loader，我们用了很多，熟悉的有 css-loader、file-loader 等。但是 loader 的机制是什么，基本的 loader 结构是怎样的，如何搭建一个 loader 开发调试环境，如何自己编写一个 loader，异步 loader 怎么处理，怎么在 loader 中运用第三方 npm 包。本文将对以上问题进行讲解。">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://hellojovy.com/webpack-loader/01.jpg">
<meta property="og:image" content="http://hellojovy.com/webpack-loader/02.jpg">
<meta property="og:image" content="http://hellojovy.com/webpack-loader/03.jpg">
<meta property="og:updated_time" content="2019-09-25T07:30:28.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="编写一个webpack的loader">
<meta name="twitter:description" content="概述对于 loader，我们用了很多，熟悉的有 css-loader、file-loader 等。但是 loader 的机制是什么，基本的 loader 结构是怎样的，如何搭建一个 loader 开发调试环境，如何自己编写一个 loader，异步 loader 怎么处理，怎么在 loader 中运用第三方 npm 包。本文将对以上问题进行讲解。">
<meta name="twitter:image" content="http://hellojovy.com/webpack-loader/01.jpg">






  <link rel="canonical" href="http://hellojovy.com/webpack-loader/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>编写一个webpack的loader | 程序收纳</title>
  






  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?78f30df6d38dd3bab6d88c9c5d807833";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>







  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">程序收纳</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <h1 class="site-subtitle" itemprop="description">写给自己看的博客</h1>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://hellojovy.com/webpack-loader/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="正月初五">
      <meta itemprop="description" content="实践总结 知识梳理 读书笔记">
      <meta itemprop="image" content="/assets/200x200.png">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程序收纳">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">编写一个webpack的loader

              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-09-25 15:30:28" itemprop="dateCreated datePublished" datetime="2019-09-25T15:30:28+08:00">2019-09-25</time>
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/工具/" itemprop="url" rel="index"><span itemprop="name">工具</span></a></span>

                
                
              
            </span>
          

          
            
            
              
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <a href="/webpack-loader/#comments" itemprop="discussionUrl">
                  <span class="post-meta-item-text">评论数：</span> <span class="post-comments-count valine-comment-count" data-xid="/webpack-loader/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="post-meta-item-icon">
            <i class="fa fa-eye"></i>
             阅读次数： 
            <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>
            </span>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><p>对于 loader，我们用了很多，熟悉的有 <code>css-loader</code>、<code>file-loader</code> 等。但是 loader 的机制是什么，基本的 loader 结构是怎样的，如何搭建一个 loader 开发调试环境，如何自己编写一个 loader，异步 loader 怎么处理，怎么在 loader 中运用第三方 npm 包。本文将对以上问题进行讲解。</p>
<a id="more"></a>
<h1 id="详述"><a href="#详述" class="headerlink" title="详述"></a>详述</h1><p>loader 只是一个导出为函数的 JavaScript 模块。loader 是用来加载处理各种形式的资源，就像工厂生产线中的一道工序，输入资源，加工处理后再输出资源。</p>
<p>loader 类似于其他构建工具中“任务(task)”，并提供了处理前端构建步骤的强大方法。loader 可以将文件从不同的语言（如 TypeScript）转换为 JavaScript，或将内联图像转换为 data URL。loader 甚至允许你直接在 JavaScript 模块中 import CSS 文件！</p>
<p><a href="https://segmentfault.com/a/1190000018450503" target="_blank" rel="noopener">源码分析</a></p>
<h2 id="最简实现"><a href="#最简实现" class="headerlink" title="最简实现"></a>最简实现</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// demo-loader</span></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">source</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> source;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="多-loader-的执行顺序"><a href="#多-loader-的执行顺序" class="headerlink" title="多 loader 的执行顺序"></a>多 loader 的执行顺序</h2><p>多个 loader 是链式调用，顺序是从后到前。例如下面示例：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.config.js</span></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="built_in">module</span>: &#123;</span><br><span class="line">    rules: [</span><br><span class="line">      &#123;</span><br><span class="line">        test: <span class="regexp">/.less$/</span>,</span><br><span class="line">        use: [</span><br><span class="line">          <span class="string">'style-loader'</span>,</span><br><span class="line">          <span class="string">'css-loader'</span>,</span><br><span class="line">          <span class="string">'less-loader'</span></span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行顺序是<code>less-loader</code> &gt; <code>css-loader</code> &gt; <code>style-loader</code>。</p>
<h2 id="loader-runner"><a href="#loader-runner" class="headerlink" title="loader-runner"></a>loader-runner</h2><p>webpack 的核心依赖包，用它来执行 loader。我们可以利用它在不用搭建完整 webpack 环境下进行 loader 的开发和调试。</p>
<p>使用方式：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; runLoaders &#125; = <span class="built_in">require</span>(<span class="string">'loader-runner'</span>);</span><br><span class="line"></span><br><span class="line">runLoaders(</span><br><span class="line">  &#123;</span><br><span class="line">    resource: <span class="string">'/abs/path/to/file.txt?query'</span>,</span><br><span class="line">    <span class="comment">// String: 资源的绝对路径 (可添加查询字符串)</span></span><br><span class="line"></span><br><span class="line">    loaders: [<span class="string">'/abs/path/to/loader.js?query'</span>],</span><br><span class="line">    <span class="comment">// String[]: loaders的绝对路径 (可添加查询字符串)</span></span><br><span class="line">    <span class="comment">// &#123;loader, options&#125;[]: 包含配置项的loaders对象的绝对路径</span></span><br><span class="line"></span><br><span class="line">    context: &#123; <span class="attr">minimize</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">    <span class="comment">// 附加loader上下文作为基本上下文</span></span><br><span class="line"></span><br><span class="line">    readResource: fs.readFile.bind(fs)</span><br><span class="line">    <span class="comment">// 一个读取资源的函数</span></span><br><span class="line">    <span class="comment">// Must have signature function(path, function(err, buffer))</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="function"><span class="keyword">function</span>(<span class="params">err, result</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// err: Error?</span></span><br><span class="line">    <span class="comment">// result.result: Buffer | String</span></span><br><span class="line">    <span class="comment">// The result</span></span><br><span class="line">    <span class="comment">// result.resourceBuffer: Buffer</span></span><br><span class="line">    <span class="comment">// The raw resource as Buffer (useful for SourceMaps)</span></span><br><span class="line">    <span class="comment">// result.cacheable: Bool</span></span><br><span class="line">    <span class="comment">// Is the result cacheable or do it require reexecution?</span></span><br><span class="line">    <span class="comment">// result.fileDependencies: String[]</span></span><br><span class="line">    <span class="comment">// An array of paths (files) on which the result depends on</span></span><br><span class="line">    <span class="comment">// result.contextDependencies: String[]</span></span><br><span class="line">    <span class="comment">// An array of paths (directories) on which the result depends on</span></span><br><span class="line">  &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<h2 id="loader-utils"><a href="#loader-utils" class="headerlink" title="loader-utils"></a>loader-utils</h2><p>webpack loaders 的工具包，提供 <code>getOptions</code>、<code>parseQuery</code> 等工具方法。使用示例如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> loaderUtils = <span class="built_in">require</span>(<span class="string">'loader-utils'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">source</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// getOptions示例</span></span><br><span class="line">  <span class="keyword">const</span> &#123; name &#125; = loaderUtils.getOptions(<span class="keyword">this</span>);</span><br><span class="line">  <span class="comment">// parseQuery示例</span></span><br><span class="line">  <span class="keyword">const</span> params = loaderUtils.parseQuery(<span class="keyword">this</span>.resourceQuery); <span class="comment">// resource: `file?param1=foo`</span></span><br><span class="line">  <span class="keyword">if</span> (params.param1 === <span class="string">'foo'</span>) &#123;</span><br><span class="line">    <span class="comment">// do something</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><a href="https://github.com/webpack/loader-utils" target="_blank" rel="noopener">更多介绍</a></p>
<h2 id="同步-loader-与异步-loader"><a href="#同步-loader-与异步-loader" class="headerlink" title="同步 loader 与异步 loader"></a>同步 loader 与异步 loader</h2><p>同步 loader 的返回值可以用 <code>return</code> 也可以用 <code>this.callback()</code>，示例如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 同步方式一：</span></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">source</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 业务处理逻辑</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> source;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 同步方式二：</span></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">source</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 业务处理逻辑</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.callback(<span class="literal">null</span>, source, map, meta);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 异步方式：</span></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">input</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> callback = <span class="keyword">this</span>.async();</span><br><span class="line">  <span class="comment">// 业务处理逻辑</span></span><br><span class="line"></span><br><span class="line">  callback(<span class="literal">null</span>, source);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>同步<code>this.callback()</code>异步<code>callback()</code>的参数类型相同，如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// callback的参数类型</span></span><br><span class="line">callback(</span><br><span class="line">  err: <span class="built_in">Error</span> | <span class="literal">null</span>,</span><br><span class="line">  content: string | Buffer,</span><br><span class="line">  sourceMap?: SourceMap,</span><br><span class="line">  meta?: any</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<h2 id="loader-中使用缓存"><a href="#loader-中使用缓存" class="headerlink" title="loader 中使用缓存"></a>loader 中使用缓存</h2><p>webpack 中默认开启 loader 缓存，如果需要关闭缓存，可以如下设置：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.cacheable(<span class="literal">false</span>);</span><br></pre></td></tr></table></figure>
<h2 id="编写-name-loader"><a href="#编写-name-loader" class="headerlink" title="编写 name-loader"></a>编写 name-loader</h2><p>实现将源数据中的 [name] 直接替换为 loader 选项中设置的 name。然后返回包含导出文本的 JavaScript 模块。</p>
<h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><h4 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h4><p><img src="/webpack-loader/01.jpg" alt=""></p>
<h4 id="工具包安装"><a href="#工具包安装" class="headerlink" title="工具包安装"></a>工具包安装</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i loader-runner loader-utils -S</span><br></pre></td></tr></table></figure>
<h4 id="源文件-index-html"><a href="#源文件-index-html" class="headerlink" title="源文件 index.html"></a>源文件 index.html</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1.0"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"X-UA-Compatible"</span> <span class="attr">content</span>=<span class="string">"ie=edge"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Hey [name]!<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="代码编写"><a href="#代码编写" class="headerlink" title="代码编写"></a>代码编写</h3><h4 id="name-loader"><a href="#name-loader" class="headerlink" title="name-loader"></a>name-loader</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// name-loader.js</span></span><br><span class="line"><span class="keyword">const</span> &#123; getOptions &#125; = <span class="built_in">require</span>(<span class="string">'loader-utils'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> <span class="title">loader</span>(<span class="params">source</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> options = getOptions(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">  source = source.replace(<span class="regexp">/\[name\]/g</span>, options.name);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="string">`module.exports = <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(source)&#125;</span>`</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="name-loader-调试脚本："><a href="#name-loader-调试脚本：" class="headerlink" title="name-loader 调试脚本："></a>name-loader 调试脚本：</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// test-name-loader.js</span></span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; runLoaders &#125; = <span class="built_in">require</span>(<span class="string">'loader-runner'</span>);</span><br><span class="line"></span><br><span class="line">runLoaders(</span><br><span class="line">  &#123;</span><br><span class="line">    resource: path.join(__dirname, <span class="string">'./src/name/index.html'</span>),</span><br><span class="line">    loaders: [</span><br><span class="line">      &#123;</span><br><span class="line">        loader: path.join(__dirname, <span class="string">'./loaders/name-loader.js'</span>),</span><br><span class="line">        options: &#123;</span><br><span class="line">          name: <span class="string">'Jovy'</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    context: &#123; <span class="attr">minimize</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">    readResource: fs.readFile.bind(fs)</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="function"><span class="keyword">function</span>(<span class="params">err, result</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">      <span class="built_in">console</span>.error(err);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'runLoaders result: '</span>, result);</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<h3 id="执行调试脚本："><a href="#执行调试脚本：" class="headerlink" title="执行调试脚本："></a>执行调试脚本：</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">H:\workspace\webpack\my-loader&gt;npm run test:name</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> my-loader@1.0.0 <span class="built_in">test</span>:name H:\workspace\webpack\my-loader</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> node <span class="built_in">test</span>-name-loader.js</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">runLoaders result:  &#123; result:</span><br><span class="line">   [ 'module.exports = "&lt;!DOCTYPE html&gt;\\r\\n&lt;html lang=\\"en\\"&gt;\\r\\n&lt;head&gt;\\r\\n  &lt;meta charset=\\"UTF-8\\"&gt;\\r\\n  &lt;meta name=\\"viewport\\" content=\\"width=device-width, initial-scale=1.0\\"&gt;\\r\\n  &lt;meta http-equiv=\\"X-UA-Compatible\\" content=\\"ie=edge\\"&gt;\\r\\n  &lt;title&gt;Document&lt;/title&gt;\\r\\n&lt;/head&gt;\\r\\n&lt;body&gt;\\r\\n  &lt;h1&gt;Hey Jovy!&lt;/h1&gt;\\r\\n&lt;/body&gt;\\r\\n&lt;/html&gt;"' ],</span><br><span class="line">  resourceBuffer:</span><br><span class="line">   &lt;Buffer 3c 21 44 4f 43 54 59 50 45 20 68 74 6d 6c 3e 0d 0a 3c 68 74 6d 6c 20 6c 61 6e 67 3d 22 65 6e 22 3e 0d 0a 3c 68 65 61 64 3e 0d 0a 20 20 3c 6d 65 74 61 ... &gt;,</span><br><span class="line">  cacheable: true,</span><br><span class="line">  fileDependencies:</span><br><span class="line">   [ 'H:\\workspace\\webpack\\my-loader\\src\\name\\index.html' ],</span><br><span class="line">  contextDependencies: [] &#125;</span><br></pre></td></tr></table></figure>
<h2 id="编写-sprite-loader"><a href="#编写-sprite-loader" class="headerlink" title="编写 sprite-loader"></a>编写 sprite-loader</h2><p>在上一个 loader 编写的环境中我们再开发一个 loader，实现自动将 css 中引用的小图片合并成雪碧图并生成新的 css 文件。</p>
<h3 id="准备工作-1"><a href="#准备工作-1" class="headerlink" title="准备工作"></a>准备工作</h3><h4 id="目录结构："><a href="#目录结构：" class="headerlink" title="目录结构："></a>目录结构：</h4><p><img src="/webpack-loader/02.jpg" alt=""></p>
<h4 id="spritesmith："><a href="#spritesmith：" class="headerlink" title="spritesmith："></a>spritesmith：</h4><p>雪碧图合并功能选用第三方 node 模块<a href="https://www.npmjs.com/package/spritesmith" target="_blank" rel="noopener">spritesmith</a>，生成雪碧图 Buffer 和坐标映射。使用示例如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Load in dependencies</span></span><br><span class="line"><span class="keyword">var</span> Spritesmith = <span class="built_in">require</span>(<span class="string">'spritesmith'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Generate our spritesheet</span></span><br><span class="line"><span class="keyword">var</span> sprites = [<span class="string">'fork.png'</span>, <span class="string">'github.png'</span>, <span class="string">'twitter.png'</span>];</span><br><span class="line">Spritesmith.run(&#123; <span class="attr">src</span>: sprites &#125;, <span class="function"><span class="keyword">function</span> <span class="title">handleResult</span>(<span class="params">err, result</span>) </span>&#123;</span><br><span class="line">  result.image; <span class="comment">// Buffer representation of image</span></span><br><span class="line">  result.coordinates; <span class="comment">// Object mapping filename to &#123;x, y, width, height&#125; of image</span></span><br><span class="line">  result.properties; <span class="comment">// Object with metadata about spritesheet &#123;width, height&#125;</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h4 id="源文件-index-css"><a href="#源文件-index-css" class="headerlink" title="源文件 index.css"></a>源文件 index.css</h4><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* src/sprite/index.css */</span></span><br><span class="line"><span class="selector-class">.img1</span> &#123;</span><br><span class="line">  <span class="attribute">background</span>: <span class="built_in">url</span>(./images/1.jpg?__sprite);</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.img2</span> &#123;</span><br><span class="line">  <span class="attribute">background</span>: <span class="built_in">url</span>(./images/2.jpg?__sprite);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="代码编写-1"><a href="#代码编写-1" class="headerlink" title="代码编写"></a>代码编写</h3><h4 id="sprite-loader"><a href="#sprite-loader" class="headerlink" title="sprite-loader"></a>sprite-loader</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// loaders/sprite-loader.js</span></span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">const</span> Spritesmith = <span class="built_in">require</span>(<span class="string">'spritesmith'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> <span class="title">loader</span>(<span class="params">source</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> callback = <span class="keyword">this</span>.async();</span><br><span class="line">  <span class="keyword">const</span> imgs = source.match(<span class="regexp">/url\((\S*)\?__sprite\)/g</span>);</span><br><span class="line">  <span class="keyword">let</span> matchedImgs = [];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; imgs.length; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> img = imgs[i].match(<span class="regexp">/url\((\S*)\?__sprite\)/</span>)[<span class="number">1</span>];</span><br><span class="line">    matchedImgs.push(path.join(process.cwd(), <span class="string">`/src/sprite/<span class="subst">$&#123;img&#125;</span>`</span>));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Spritesmith.run(&#123; <span class="attr">src</span>: matchedImgs &#125;, <span class="function"><span class="keyword">function</span> <span class="title">handleResult</span>(<span class="params">err, result</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> spritePath = path.join(process.cwd(), <span class="string">'dist/sprite.jpg'</span>);</span><br><span class="line">    fs.writeFileSync(spritePath, result.image);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> imgsData = [];</span><br><span class="line">    <span class="built_in">Object</span>.keys(result.coordinates).forEach(<span class="function"><span class="params">key</span> =&gt;</span> &#123;</span><br><span class="line">      imgsData.push(result.coordinates[key]);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    imgs.forEach(<span class="function">(<span class="params">img, index</span>) =&gt;</span> &#123;</span><br><span class="line">      source = source.replace(</span><br><span class="line">        imgs[index],</span><br><span class="line">        <span class="string">`url("dist/sprite.jpg") <span class="subst">$&#123;-imgsData[index].x&#125;</span>px <span class="subst">$&#123;-imgsData[index].y&#125;</span>px`</span></span><br><span class="line">      );</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    callback(<span class="literal">null</span>, source);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="sprite-loader-调试脚本"><a href="#sprite-loader-调试脚本" class="headerlink" title="sprite-loader 调试脚本"></a>sprite-loader 调试脚本</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/test-sprite-loader.js</span></span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; runLoaders &#125; = <span class="built_in">require</span>(<span class="string">'loader-runner'</span>);</span><br><span class="line"></span><br><span class="line">runLoaders(</span><br><span class="line">  &#123;</span><br><span class="line">    resource: path.join(__dirname, <span class="string">'./src/sprite/index.css'</span>),</span><br><span class="line">    loaders: [path.join(__dirname, <span class="string">'./loaders/sprite-loader.js'</span>)],</span><br><span class="line">    context: &#123; <span class="attr">minimize</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">    readResource: fs.readFile.bind(fs)</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="function"><span class="keyword">function</span>(<span class="params">err, result</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">      <span class="built_in">console</span>.error(err);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fs.writeFileSync(</span><br><span class="line">      path.join(process.cwd(), <span class="string">'dist/index.css'</span>),</span><br><span class="line">      result.resourceBuffer</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'runLoaders result: '</span>, result);</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<h3 id="执行调试脚本"><a href="#执行调试脚本" class="headerlink" title="执行调试脚本"></a>执行调试脚本</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">H:\workspace\webpack\my-loader&gt;npm run test:sprite</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> my-loader@1.0.0 <span class="built_in">test</span>:sprite H:\workspace\webpack\my-loader</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> node <span class="built_in">test</span>-sprite-loader.js</span></span><br><span class="line"></span><br><span class="line">runLoaders result:  &#123; result:</span><br><span class="line">   [ '.img1&#123;\r\n  background: url("dist/sprite.jpg") -777px 0px;\r\n&#125;\r\n.img2&#123;\r\n  background: url("dist/sprite.jpg") 0px 0px;\r\n&#125;' ],</span><br><span class="line">  resourceBuffer:</span><br><span class="line">   &lt;Buffer 2e 69 6d 67 31 7b 0d 0a 20 20 62 61 63 6b 67 72 6f 75 6e 64 3a 20 75 72 6c 28 2e 2f 69 6d 61 67 65 73 2f 31 2e 6a 70 67 3f 5f 5f 73 70 72 69 74 65 29 ... &gt;,</span><br><span class="line">  cacheable: true,</span><br><span class="line">  fileDependencies:</span><br><span class="line">   [ 'H:\\workspace\\webpack\\my-loader\\src\\sprite\\index.css' ],</span><br><span class="line">  contextDependencies: [] &#125;</span><br></pre></td></tr></table></figure>
<h2 id="编写-loader-用法准则及注意事项"><a href="#编写-loader-用法准则及注意事项" class="headerlink" title="编写 loader 用法准则及注意事项"></a>编写 loader 用法准则及注意事项</h2><h3 id="用法准则"><a href="#用法准则" class="headerlink" title="用法准则"></a>用法准则</h3><ul>
<li>简单易用。</li>
<li>使用链式传递。</li>
<li>模块化的输出。</li>
<li>确保无状态。</li>
<li>使用 loader utilities。</li>
<li>记录 loader 的依赖。</li>
<li>解析模块依赖关系。</li>
<li>提取通用代码。</li>
<li>避免绝对路径。</li>
<li>使用 peer dependencies。</li>
</ul>
<h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><p>如果该 loader 是最终执行 loader（如 file-loader、style-loader 等），那么返回值应该是字符串，包含导出文本的 JavaScript 模块；如果该 loader 不是最终执行 loader（如 css-loader、sass-loader），那么返回值应该是 Buffer，将作为链式处理的 loader 的 source。</p>
<h2 id="自定义-loader-的使用"><a href="#自定义-loader-的使用" class="headerlink" title="自定义 loader 的使用"></a>自定义 loader 的使用</h2><p>只有一点需要注意，就是通过 <code>resolveLoader</code> 配置项指定 loader 的搜寻顺序。</p>
<h3 id="使用示例"><a href="#使用示例" class="headerlink" title="使用示例"></a>使用示例</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">const</span> HtmlWebpackPlugin = <span class="built_in">require</span>(<span class="string">'html-webpack-plugin'</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; CleanWebpackPlugin &#125; = <span class="built_in">require</span>(<span class="string">'clean-webpack-plugin'</span>);</span><br><span class="line"><span class="keyword">const</span> HotModuleReplacementPlugin = <span class="built_in">require</span>(<span class="string">'webpack'</span>)</span><br><span class="line">  .HotModuleReplacementPlugin;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  entry: <span class="string">'./src/index.js'</span>,</span><br><span class="line">  output: &#123;</span><br><span class="line">    path: path.join(__dirname, <span class="string">'dist'</span>),</span><br><span class="line">    filename: <span class="string">'bundle.js'</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="built_in">module</span>: &#123;</span><br><span class="line">    rules: [</span><br><span class="line">      &#123;</span><br><span class="line">        test: <span class="regexp">/\.html$/</span>,</span><br><span class="line">        use: [</span><br><span class="line">          &#123;</span><br><span class="line">            loader: <span class="string">'name-loader'</span>,</span><br><span class="line">            options: &#123;</span><br><span class="line">              name: <span class="string">'Jovy'</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        test: <span class="regexp">/\.css$/</span>,</span><br><span class="line">        loader: [<span class="string">'style-loader'</span>, <span class="string">'css-loader'</span>, <span class="string">'sprite-loader'</span>]</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        test: <span class="regexp">/\.jpg$/</span>,</span><br><span class="line">        loader: [</span><br><span class="line">          &#123;</span><br><span class="line">            loader: <span class="string">'file-loader'</span>,</span><br><span class="line">            options: &#123;</span><br><span class="line">              name(file) &#123;</span><br><span class="line">                <span class="keyword">if</span> (process.env.NODE_ENV === <span class="string">'development'</span>) &#123;</span><br><span class="line">                  <span class="keyword">return</span> <span class="string">'[path][name].[ext]'</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> <span class="string">'[contenthash:8].[ext]'</span>;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  devServer: &#123;</span><br><span class="line">    contentBase: path.join(__dirname, <span class="string">'dist'</span>),</span><br><span class="line">    compress: <span class="literal">true</span>,</span><br><span class="line">    port: <span class="number">9000</span>,</span><br><span class="line">    hot: <span class="literal">true</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 指定loader搜寻顺序</span></span><br><span class="line">  resolveLoader: &#123;</span><br><span class="line">    modules: [path.join(__dirname, <span class="string">'./loaders'</span>), <span class="string">'node_modules'</span>]</span><br><span class="line">  &#125;,</span><br><span class="line">  plugins: [</span><br><span class="line">    <span class="keyword">new</span> CleanWebpackPlugin(),</span><br><span class="line">    <span class="keyword">new</span> HtmlWebpackPlugin(&#123;</span><br><span class="line">      template: path.join(__dirname, <span class="string">`src/index.html`</span>),</span><br><span class="line">      filename: <span class="string">`index.html`</span></span><br><span class="line">    &#125;),</span><br><span class="line">    <span class="keyword">new</span> HotModuleReplacementPlugin()</span><br><span class="line">  ]</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="效果展示"><a href="#效果展示" class="headerlink" title="效果展示"></a>效果展示</h3><p><img src="/webpack-loader/03.jpg" alt=""></p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://webpack.docschina.org/contribute/writing-a-loader/" target="_blank" rel="noopener">https://webpack.docschina.org/contribute/writing-a-loader/</a></p>
<p><a href="https://segmentfault.com/a/1190000014205729" target="_blank" rel="noopener">https://segmentfault.com/a/1190000014205729</a></p>
<p>《极客时间》</p>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/webpack/" rel="tag"># webpack</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/webpack-plugin-mechanism/" rel="next" title="webpack插件机制">
                <i class="fa fa-chevron-left"></i> webpack插件机制
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/webpack-config/" rel="prev" title="编写可维护的webpack构建配置">
                编写可维护的webpack构建配置 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div class="comments" id="comments">
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/assets/200x200.png" alt="正月初五">
            
              <p class="site-author-name" itemprop="name">正月初五</p>
              <p class="site-description motion-element" itemprop="description">实践总结 知识梳理 读书笔记</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">105</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">7</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">17</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://github.com/jovysun" title="GitHub &rarr; https://github.com/jovysun" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="mailto:jovysun@163.com" title="E-Mail &rarr; mailto:jovysun@163.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                </span>
              
            </div>
          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#概述"><span class="nav-number">1.</span> <span class="nav-text">概述</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#详述"><span class="nav-number">2.</span> <span class="nav-text">详述</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#最简实现"><span class="nav-number">2.1.</span> <span class="nav-text">最简实现</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#多-loader-的执行顺序"><span class="nav-number">2.2.</span> <span class="nav-text">多 loader 的执行顺序</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#loader-runner"><span class="nav-number">2.3.</span> <span class="nav-text">loader-runner</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#loader-utils"><span class="nav-number">2.4.</span> <span class="nav-text">loader-utils</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#同步-loader-与异步-loader"><span class="nav-number">2.5.</span> <span class="nav-text">同步 loader 与异步 loader</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#loader-中使用缓存"><span class="nav-number">2.6.</span> <span class="nav-text">loader 中使用缓存</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#编写-name-loader"><span class="nav-number">2.7.</span> <span class="nav-text">编写 name-loader</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#准备工作"><span class="nav-number">2.7.1.</span> <span class="nav-text">准备工作</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#目录结构"><span class="nav-number">2.7.1.1.</span> <span class="nav-text">目录结构</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#工具包安装"><span class="nav-number">2.7.1.2.</span> <span class="nav-text">工具包安装</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#源文件-index-html"><span class="nav-number">2.7.1.3.</span> <span class="nav-text">源文件 index.html</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#代码编写"><span class="nav-number">2.7.2.</span> <span class="nav-text">代码编写</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#name-loader"><span class="nav-number">2.7.2.1.</span> <span class="nav-text">name-loader</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#name-loader-调试脚本："><span class="nav-number">2.7.2.2.</span> <span class="nav-text">name-loader 调试脚本：</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#执行调试脚本："><span class="nav-number">2.7.3.</span> <span class="nav-text">执行调试脚本：</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#编写-sprite-loader"><span class="nav-number">2.8.</span> <span class="nav-text">编写 sprite-loader</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#准备工作-1"><span class="nav-number">2.8.1.</span> <span class="nav-text">准备工作</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#目录结构："><span class="nav-number">2.8.1.1.</span> <span class="nav-text">目录结构：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#spritesmith："><span class="nav-number">2.8.1.2.</span> <span class="nav-text">spritesmith：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#源文件-index-css"><span class="nav-number">2.8.1.3.</span> <span class="nav-text">源文件 index.css</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#代码编写-1"><span class="nav-number">2.8.2.</span> <span class="nav-text">代码编写</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#sprite-loader"><span class="nav-number">2.8.2.1.</span> <span class="nav-text">sprite-loader</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#sprite-loader-调试脚本"><span class="nav-number">2.8.2.2.</span> <span class="nav-text">sprite-loader 调试脚本</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#执行调试脚本"><span class="nav-number">2.8.3.</span> <span class="nav-text">执行调试脚本</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#编写-loader-用法准则及注意事项"><span class="nav-number">2.9.</span> <span class="nav-text">编写 loader 用法准则及注意事项</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#用法准则"><span class="nav-number">2.9.1.</span> <span class="nav-text">用法准则</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#注意事项"><span class="nav-number">2.9.2.</span> <span class="nav-text">注意事项</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#自定义-loader-的使用"><span class="nav-number">2.10.</span> <span class="nav-text">自定义 loader 的使用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#使用示例"><span class="nav-number">2.10.1.</span> <span class="nav-text">使用示例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#效果展示"><span class="nav-number">2.10.2.</span> <span class="nav-text">效果展示</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#参考"><span class="nav-number">3.</span> <span class="nav-text">参考</span></a></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2017 – <span itemprop="copyrightYear">2021</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">正月初五</span>

  

  
</div>









        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="post-meta-item-icon">
      <i class="fa fa-user"></i>
    </span>
    <span class="site-uv" title="总访客量">
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  

  
    <span class="post-meta-divider">|</span>
  

  
    <span class="post-meta-item-icon">
      <i class="fa fa-eye"></i>
    </span>
    <span class="site-pv" title="总访问量">
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>









        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=6.7.0"></script>

  <script src="/js/src/motion.js?v=6.7.0"></script>



  
  


  <script src="/js/src/affix.js?v=6.7.0"></script>

  <script src="/js/src/schemes/pisces.js?v=6.7.0"></script>




  
  <script src="/js/src/scrollspy.js?v=6.7.0"></script>
<script src="/js/src/post-details.js?v=6.7.0"></script>



  


  <script src="/js/src/bootstrap.js?v=6.7.0"></script>



  
  

<script src="//cdn1.lncld.net/static/js/3.11.1/av-min.js"></script>



<script src="//unpkg.com/valine/dist/Valine.min.js"></script>

<script>
  var GUEST = ['nick', 'mail', 'link'];
  var guest = 'nick,mail,link';
  guest = guest.split(',').filter(function(item) {
    return GUEST.indexOf(item) > -1;
  });
  new Valine({
    el: '#comments',
    verify: false,
    notify: false,
    appId: 'kwRsvUOXclo28PbRHx4yx9gb-gzGzoHsz',
    appKey: 'b1IwY2KUEiMwBO2lRLehboPT',
    placeholder: 'Just go go',
    avatar: '',
    meta: guest,
    pageSize: '10' || 10,
    visitor: false
  });
</script>




  


  

  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.json";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  
  <script>
    (function(){
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
      }
      else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
    })();
  </script>


  

  

  

  

  

  

  

  

  

  

</body>
</html>
